<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Studio de Production - Cahier des Charges 3D</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://images.unsplash.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    html { scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #444444 #1E1E1E; }
    body { font-family: 'Montserrat', sans-serif; background-color: #121212; color: #EAEAEA;
      background-image: linear-gradient(rgba(18, 18, 18, 0.92), rgba(18, 18, 18, 0.92)), url('https://images.unsplash.com/photo-1604975701397-1cfdf50bd745?q=80&w=1974&auto=format&fit=crop');
      background-size: cover; background-position: center; background-attachment: fixed; }
    .text-gold { color: #D4AF37; }
    .bg-card { background-color: #1E1E1E; }
    .border-card { border-color: #444; }
    .modal { transition: opacity .25s ease, visibility .25s ease; }
    .modal-content { transition: transform .25s ease; }
    .card-hover { transition: transform .18s ease-out, box-shadow .18s ease-out, border-color .18s ease-out; border: 1px solid #333; display: flex; flex-direction: column; }
    .card-hover:hover, .card-hover:focus-visible { transform: translateY(-4px); box-shadow: 0 0 22px rgba(212, 175, 55, .14); border-color: rgba(212, 175, 55, .5); outline: none; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1E1E1E; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #D4AF37; }
    input::placeholder { color: #999; }
    .highlight, .suggestion-active { background-color: rgba(212, 175, 55, 0.15); }
    .highlight { border-left: 3px solid #D4AF37; border-radius: 2px; }
    #projects-grid > div { opacity: 1; transform: scale(1); transition: opacity .25s ease, transform .25s ease; }
    #projects-grid.filtering > div { opacity: 0; transform: scale(.97); }
    /* Centrage du dernier item quand la derni√®re ligne ne contient qu'une carte (>= 1280px) */
    @media (min-width:1280px){
      #projects-grid:has(> :nth-child(3n+1):last-child) > :last-child { grid-column: 2; }
    }
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
    .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body class="antialiased">
  <div class="body-overlay min-h-screen">
    <div id="app-container" class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <header class="text-center mb-16">
        <h1 class="text-5xl sm:text-7xl font-bold text-white tracking-wider">STUDIO DE PRODUCTION</h1>
        <div class="mt-4 text-lg text-gold uppercase tracking-[0.2em]">Cahier des Charges 3D</div>
        <a href="https://drive.google.com/drive/folders/1x6nghmXtweIPvZgp7DjSP-8PAH4O8iPd" target="_blank" rel="noopener noreferrer" class="mt-8 inline-block bg-transparent border border-gold text-gold font-semibold py-2 px-6 rounded-lg hover:bg-gold hover:text-black transition-colors duration-300">Acc√©der au Drive du Projet <span aria-hidden="true">‚Üó</span></a>
        <div id="results-live" class="sr-only" aria-live="polite"></div>
      </header>

      <section id="deliverables" class="mb-16 bg-card/50 p-6 rounded-2xl border border-card">
        <h2 class="text-3xl font-semibold text-gold mb-6 text-center">Les Livrables</h2>
        <div class="flex flex-col md:flex-row justify-center items-stretch gap-8 text-center">
          <div class="flex-1 bg-card p-8 rounded-xl border border-card">
            <span class="text-6xl" aria-hidden="true">üéûÔ∏è</span>
            <h3 class="text-2xl font-bold text-white mt-4 mb-2">Film de Projet de Groupe</h3>
            <p class="text-gray-200"><strong class="font-semibold text-gold">Dur√©e :</strong> 90 √† 120 secondes</p>
            <p class="text-sm text-gray-400 mt-3">Racontez l'histoire de votre univers. La vid√©o doit pr√©senter l'espace complet et d√©montrer la synergie de vos cr√©ations.</p>
          </div>
          <div class="flex-1 bg-card p-8 rounded-xl border border-card">
            <span class="text-6xl" aria-hidden="true">‚ú®</span>
            <h3 class="text-2xl font-bold text-white mt-4 mb-2">Votre Publicit√© (Spot 20-30s)</h3>
            <p class="text-gray-200"><strong class="font-semibold text-gold">Dur√©e :</strong> 20 √† 30 secondes</p>
            <p class="text-sm text-gray-400 mt-3">C'est votre carte de visite. Mettez en valeur votre mod√©lisation sous son meilleur jour, en soulignant les d√©tails et votre savoir-faire.</p>
          </div>
        </div>
      </section>

      <section id="projects">
        <h2 class="text-3xl font-semibold text-gold mb-8 text-center">Les Productions en Cours</h2>
        <div class="sticky top-0 z-20 bg-[#121212]/80 backdrop-blur-md py-4 mb-8 rounded-xl">
          <div class="flex flex-col items-center justify-center">
            <div class="relative w-full sm:w-96" aria-label="Recherche de r√©alisateur">
              <input type="text" id="student-search" placeholder="Trouver un r√©alisateur..." class="w-full bg-card border border-card rounded-lg py-2 px-4 leading-tight focus:outline-none focus:bg-card focus:border-gold" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-controls="autocomplete-list" autocomplete="off" autocapitalize="off" spellcheck="false" />
              <div id="autocomplete-list" class="absolute hidden w-full mt-1 bg-card border border-card rounded-lg shadow-lg max-h-60 overflow-y-auto z-30" role="listbox"></div>
            </div>
            <p class="mt-2 text-xs text-gray-500">Astuce¬†: appuyez sur <kbd class="px-1 py-0.5 bg-card border border-card rounded">/</kbd> pour focaliser la recherche.</p>
          </div>
        </div>
        <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
      </section>
    </div>

    <div id="project-modal" class="modal invisible opacity-0 fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-70 backdrop-blur-sm">
      <div class="min-h-full flex items-center justify-center p-4">
        <div class="modal-content transform -translate-y-10 bg-card w-full max-w-3xl rounded-2xl shadow-2xl flex flex-col border border-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
          <div class="p-4 sm:p-6 border-b border-card flex justify-between items-center flex-shrink-0">
            <h2 id="modal-title" class="text-2xl font-bold text-gold"></h2>
            <button id="modal-close" class="text-gray-400 hover:text-white rounded-full h-12 w-12 flex items-center justify-center text-4xl leading-none" aria-label="Fermer la fen√™tre">&times;</button>
          </div>
          <div class="p-4 sm:p-6 overflow-y-auto">
            <div id="modal-body"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Donn√©es ---
    const projectData = [
      { id: 1, name: 'The Nexus: Multi-Verse Library', mission: 'Cr√©ez un sanctuaire immersif pour les fans de fiction. Chaque zone th√©matique doit transporter le visiteur dans son univers favori gr√¢ce √† un design (architecture, mobilier, lumi√®re) qui raconte une histoire.', students: [
        { name: 'Rayane', class: 'B', mission: { title: 'Le Tr√¥ne de la Marionnettiste', description: 'Mod√©lisez un fauteuil de lecture sculptural pour la zone Manhwa. Ce doit √™tre une ≈ìuvre d\'art √©voquant pouvoir et √©l√©gance, qui invite √† l\'immersion.' } },
        { name: 'Erudice', class: 'B', mission: { title: 'Le Sanctuaire Otaku', description: 'Imaginez un syst√®me de lecture modulaire sous forme d\'alc√¥ves ou de cocons personnalis√©s, o√π chaque niche est d√©di√©e √† une s√©rie culte.' } },
        { name: 'Pascal', class: 'A', mission: { title: 'La Station de Gaming Immersive', description: 'Int√©grez un setup de jeu complet dans une biblioth√®que, en soignant la gestion des c√¢bles, l\'√©clairage et les supports pour figurines.' } },
        { name: 'Jennifer', class: 'B', mission: { title: 'La Porte des Mondes', description: 'Concevez l\'entr√©e principale du Nexus. Qu\'il s\'agisse d\'une arche ou d\'une biblioth√®que-portail, sa structure doit sugg√©rer le passage entre les univers.' } }
      ] },
      { id: 2, name: 'Fourth Gen Studio', mission: 'Imaginez un laboratoire cr√©atif o√π les outils physiques et les ≈ìuvres num√©riques fusionnent. L\'espace doit √™tre modulable et inspirant, avec une architecture qui participe elle-m√™me au processus de cr√©ation.', students: [
        { name: 'Achabys', class: 'B', mission: { title: 'L\'Installation Cin√©tique Murale', description: 'Cr√©ez une surface murale "vivante" avec des panneaux rotatifs. Votre installation doit permettre de jouer avec la lumi√®re et la texture pour animer les projections 3D.' } },
        { name: 'Rolyx', class: 'A', mission: { title: 'Le Poste de Rendu "Think Outside the Box"', description: 'Concevez le poste de travail ultime pour un artiste num√©rique, en alliant une ergonomie parfaite √† une esth√©tique futuriste et audacieuse.' } },
        { name: 'Duamel', class: 'B', mission: { title: 'Le Mur d\'Inspiration Modulable', description: 'Proposez un syst√®me d\'affichage (magn√©tique, modulable) √† la fois fonctionnel et esth√©tique, qui devient une composition artistique √©volutive.' } },
        { name: 'Lois', class: 'B', mission: { title: 'L\'Autel des Sens', description: 'Mod√©lisez un diffuseur de parfum sculptural et un syst√®me d\'√©clairage d\'ambiance qui permettent de cr√©er une atmosph√®re unique pour la photographie.' } }
      ] },
      { id: 3, name: 'The Blockbuster Factory', mission: 'L\'enjeu de ce projet est la transformation. Votre mission est de concevoir un espace cam√©l√©on, capable de changer radicalement d\'ambiance en un temps record. La modularit√©, l\'ing√©niosit√© et la polyvalence du mobilier sont les cl√©s du succ√®s.', students: [
        { name: 'Iris', class: 'A', mission: { title: 'Le Bar de Toretto', description: 'Cr√©ez un bar mobile au design industriel, inspir√© de *Fast & Furious*. Il doit √™tre robuste, fonctionnel et suffisamment charismatique pour devenir une pi√®ce centrale.' } },
        { name: 'Noriane', class: 'A', mission: { title: 'La Loge de Star "PDG"', description: 'Am√©nagez une loge de pr√©paration luxueuse et high-tech. Pensez au confort et √† l\'efficacit√© professionnelle en int√©grant un miroir, un √©clairage et des rangements optimaux.' } },
        { name: 'Lindsay', class: 'B', mission: { title: 'Le Salon de mise en sc√®ne modulable', description: 'Concevez un ensemble de meubles comme des briques cr√©atives, faciles √† d√©placer et reconfigurer pour cr√©er plusieurs ambiances de tournage.' } },
        { name: 'Kassandra', class: 'A', mission: { title: 'La Cuisine de "Bricoleuse"', description: 'Mod√©lisez une cuisine de plateau de tournage. Elle doit √™tre esth√©tique sous tous les angles, fonctionnelle et facilement adaptable √† diff√©rents sc√©narios.' } }
      ] },
      { id: 4, name: 'The Power Suit Office', mission: 'Votre mission est de mat√©rialiser le pouvoir, l\'ambition et l\'√©l√©gance dans un environnement de travail. Chaque meuble et chaque mat√©riau doit respirer le succ√®s et la confiance. Concevez une v√©ritable d√©claration de statut, un espace con√ßu pour prendre des d√©cisions qui changent la donne.', students: [
        { name: 'Ghintia', class: 'B', mission: { title: 'Le Bureau de l\'Associ√© Principal', description: 'Concevez un bureau qui impose le respect par son design et ses mat√©riaux nobles (bois sombre, marbre). Il doit √™tre massif mais √©l√©gant.' } },
        { name: 'Gloria', class: 'A', mission: { title: 'La Salle du Conseil d\'Administration', description: 'Imaginez une table de r√©union imposante qui favorise la communication, en int√©grant la technologie de mani√®re discr√®te.' } },
        { name: 'Vianney', class: 'B', mission: { title: 'Le Bureau Ex√©cutif Augment√©', description: 'Cr√©ez un poste de contr√¥le personnel o√π design et technologie dialoguent. Int√©grez des surprises spatiales et une vraie sensation de ma√Ætrise.' } },
        { name: 'Ian', class: 'A', mission: { title: 'La Biblioth√®que Juridique Murale', description: 'Concevez une biblioth√®que monumentale qui agit comme un mur de savoir et de prestige, structurant l\'espace sans √©craser.' } }
      ] },
      { id: 5, name: 'The Street Food Arena', mission: 'Votre objectif est de capturer l\'√©nergie brute de la rue et de la canaliser dans un lieu vibrant et √©lectrique. Pensez cet espace comme un festival permanent o√π le design industriel, fonctionnel et un peu rebelle sert de sc√®ne √† la culture urbaine et culinaire.', students: [
        { name: 'Tryphose', class: 'B', mission: { title: 'Le Totem Urbain : Bar & DJ Booth', description: 'Cr√©ez une structure centrale (type container/√©chafaudage) qui sert √† la fois de bar principal et de cabine sur√©lev√©e pour le DJ. Elle doit √™tre un point de ralliement visible.' } },
        { name: 'Sarah', class: 'A', mission: { title: 'Le Stand de P√¢tisserie Urbaine', description: 'Imaginez un kiosque ou un food truck au design cr√©atif, attractif et hyper-fonctionnel dans un espace r√©duit.' } },
        { name: 'Gr√¢ce', class: 'B', mission: { title: 'La Cuisine de Battle Ouverte', description: 'Concevez le "ring" des chefs. L\'ergonomie et l\'efficacit√© sont essentielles pour la performance sous pression, tout en offrant un spectacle au public.' } },
        { name: 'Stessy', class: 'A', mission: { title: 'La Sc√®ne des Artistes Urbains', description: 'Concevez une petite sc√®ne modulable pour des performances live. Elle doit respirer l\'improvisation et l\'√©nergie urbaine.' } }
      ] },
      { id: 6, name: 'The Oasis: Detox & Design', mission: 'Concevez une exp√©rience de d√©connexion totale √† travers le design. Ce spa futuriste doit √™tre un lieu √©pur√© et surprenant, o√π la technologie est utilis√©e pour amplifier les sensations et apaiser l\'esprit. Chaque d√©tail doit contribuer √† cr√©er une bulle hors du temps.', students: [
        { name: 'Brunelle', class: 'B', mission: { title: 'La Chaise Longue "Nail Art" Sculpturale', description: 'Imaginez une chaise longue comme une sculpture fonctionnelle. Inspirez-vous de l\'onglerie pour ses formes fluides et sa finition laqu√©e, sans tomber dans le litt√©ral.' } },
        { name: 'Myra', class: 'B', mission: { title: 'Le Mini-Booth de Coiffure Interactif', description: 'Concevez un espace privatif et luxueux pour la coiffure et le maquillage. Le miroir interactif devient la pi√®ce centrale de l\'exp√©rience.' } },
        { name: '√âmeraude', class: 'A', mission: { title: 'Le Hammam Sc√©nographique', description: 'Concevez un hammam o√π la lumi√®re et le son accompagnent la chaleur. L\'ambiance doit √™tre immersive et √©volutive.' } },
        { name: 'Esther', class: 'B', mission: { title: 'La Salle de Repos Dystopique', description: 'Am√©nagez un cocon de m√©ditation o√π des projections enveloppantes transforment l\'espace en un paysage mental apaisant.' } }
      ] },
      { id: 7, name: 'The Lore Lodge', mission: 'Votre d√©fi est de cr√©er une boutique-h√¥tel/concept store dont les espaces racontent une histoire immersive. Le client ne doit pas simplement occuper une chambre...mais habiter un univers.', students: [
        { name: 'Elicia', class: 'B', mission: { title: 'Le Lit Signature', description: 'Mod√©lisez un lit et sa t√™te de lit comme la d√©claration principale de l\'univers choisi, en alliant un design fort et un confort r√©el.' } },
        { name: 'Faghez', class: 'B', mission: { title: 'Le Dressing Th√©matique', description: 'Concevez un espace de rangement qui prolonge l\'univers de la chambre. Les gestes d\'usage r√©v√®lent le th√®me.' } },
        { name: 'Loan', class: 'A', mission: { title: 'L\'Ouverture sur le Monde', description: 'Imaginez un balcon ou une fen√™tre qui soit aussi une fen√™tre sur l\'imaginaire. Des effets visuels viennent augmenter le r√©el.' } },
        { name: 'Lydia', class: 'A', mission: { title: 'L\'Assise Principale', description: 'Cr√©ez une assise sculpturale qui ancre le th√®me d√®s le premier regard. La forme prime sur la modularit√©.' } }
      ] },
      { id: 8, name: 'The Mind Retreat', mission: 'Votre objectif est de concevoir un refuge pour l\'esprit, un lieu de reconnexion avec soi-m√™me et la nature. L\'architecture doit √™tre humble, au service du bien-√™tre.', students: [
        { name: 'Coralie', class: 'B', mission: { title: 'La Biblioth√®que Personnalis√©e', description: 'Imaginez une biblioth√®que qui invite √† la d√©couverte, avec des modules qui peuvent aussi devenir des assises.' } },
        { name: 'Ruth A.', class: 'B', mission: { title: 'Le Chevalet de Peinture face √† la Mer', description: 'Cr√©ez un espace minimaliste o√π chaque √©l√©ment est un bel objet fonctionnel en harmonie avec le paysage.' } },
        { name: 'Jessica', class: 'A', mission: { title: 'Le Mur V√©g√©tal Int√©rieur/Ext√©rieur', description: 'Concevez une transition douce entre l\'int√©rieur et la nature, comme si le v√©g√©tal entrait dans la pi√®ce.' } },
        { name: 'Ronelle', class: 'A', mission: { title: 'Le Lit-Nid de Lecture', description: 'Imaginez un lit pour s\'√©vader, plus que pour dormir : confortable, enveloppant, propice √† la lecture.' } },
        { name: 'Marie T.', class: 'A', mission: { title: 'La Sc√®ne de Cr√©ation', description: 'Concevez une table basse comme un mini-atelier, avec une surface inspirante et un √©clairage intime.' } }
      ] },
      { id: 9, name: 'S√®me City OPEN PARK (SCOP)', mission: 'Ce projet doit √™tre pens√© pour l\'impact r√©el. Votre mission est de transformer un espace public en un lieu de vie urbain, fonctionnel et esth√©tique.', students: [
        { name: 'Ashley', class: 'B', mission: { title: 'La Toiture Dansante & Intelligente', description: 'Cr√©ez une structure d\'ombrage sculpturale qui marie forme et usage, en dialoguant avec la pluie et la lumi√®re.' } },
        { name: 'Korel', class: 'A', mission: { title: 'L\'Abri Urbain Modulaire', description: 'Concevez des abris comme des points de rencontre confortables et s√©curisants, adaptables √† diff√©rents lieux du parc.' } },
        { name: 'Lidwine', class: 'A', mission: { title: 'Le Mobilier Institutionnel', description: 'Imaginez des bancs, poubelles et bornes d\'information qui portent l\'identit√© du parc par un design robuste et clair.' } },
        { name: 'Shaneen', class: 'A', mission: { title: 'L\'Aire de Jeux "Kawaii"', description: 'Cr√©ez une aire de jeux qui stimule l\'imagination en toute s√©curit√©, avec des formes douces et des structures originales.' } }
      ] },
      { id: 10, name: 'The Kinetic Stage', mission: 'Pensez ce studio comme une sc√®ne de th√©√¢tre pour la cr√©ation. L\'espace doit se m√©tamorphoser selon les besoins (shooting, atelier, showroom).', students: [
        { name: 'Zirwath', class: 'B', mission: { title: 'Le portant √† v√™tements sculptural', description: 'R√©inventez le portant pour qu\'il devienne une pi√®ce de design √† part enti√®re, mobile et expressive.' } },
        { name: 'Aubine', class: 'A', mission: { title: 'Le miroir sur pied ¬´ filaire ¬ª', description: 'Concevez un miroir l√©ger et po√©tique, comme une ligne dessin√©e dans l\'espace.' } },
        { name: 'Ma√´lys', class: 'A', mission: { title: 'La table de cr√©ation ¬´ rustique minimaliste ¬ª', description: 'Imaginez une grande table de travail en mat√©riaux bruts, qui puisse se diviser en plusieurs postes ind√©pendants.' } },
        { name: 'Tiffany', class: 'A', mission: { title: "Le salon d'accueil modulable", description: 'Cr√©ez un ensemble de si√®ges pour l\'accueil qui puisse se reconfigurer facilement, passant d\'une zone d\'attente √† un espace de brainstorming.' } },
        { name: 'Roxane', class: 'A', mission: { title: 'La Station d\'√âcoute R√©tro-Kinetic', description: 'Concevez un meuble qui cache et r√©v√®le une platine vinyle. Le m√©canisme d\'ouverture doit cr√©er un petit moment de th√©√¢tre.' } }
      ] }
    ];

    // --- Utils ---
    const $$ = (sel, root=document) => root.querySelector(sel);
    const $$$ = (sel, root=document) => root.querySelectorAll(sel);
    const normalize = (str) => str.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
    const escapeHTML = (s) => s.replace(/[&<>\"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));

    // Pr√©-indexation
    const preIndexed = projectData.map(p => ({ id:p.id, name:p.name, mission:p.mission, students:p.students, studentNamesNorm:p.students.map(s=>normalize(s.name)) }));
    const allStudentNames = [...new Set(projectData.flatMap(p => p.students.map(s => s.name)))].sort();

    // --- Refs DOM ---
    const projectsGrid = $$('#projects-grid');
    const studentSearch = $$('#student-search');
    const autocompleteList = $$('#autocomplete-list');
    const modal = $$('#project-modal');
    const modalClose = $$('#modal-close');
    const modalTitle = $$('#modal-title');
    const modalBody = $$('#modal-body');
    const live = $$('#results-live');

    let previouslyFocusedElement = null, activeSuggestion = -1, lastQuery = '';

    const debounce = (fn, d=150) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), d); }; };

    const cardHTML = (project, qNorm) => {
      const memberCount = project.students.length;
      const matching = qNorm ? project.students.filter(s => normalize(s.name).includes(qNorm)).map(s=>s.name) : [];
      const matches = matching.length ? `<div class=\"mt-4 pt-4 border-t border-card\"><p class=\"text-xs text-gray-400\">R√©sultat pour : <span class=\"font-semibold text-gold\">${escapeHTML(matching.join(', '))}</span></p></div>` : '';
      return `
        <div class=\"bg-card p-6 rounded-2xl cursor-pointer card-hover\" data-project-id=\"${project.id}\" role=\"button\" tabindex=\"0\">
          <div class=\"flex-grow\">
            <h3 class=\"text-2xl font-bold text-white mb-2\">${escapeHTML(project.name)}</h3>
            <p class=\"text-sm text-gray-400 mb-4\">${escapeHTML(project.mission)}</p>
          </div>
          <div class=\"mt-auto\">
            <div class=\"flex justify-between items-center text-sm pt-4 border-t border-card\">
              <span class=\"font-semibold text-gray-300\">${memberCount} r√©alisateur${memberCount>1?'s':''}</span>
              <span class=\"text-gold font-medium\">Consulter le Brief ‚Üí</span>
            </div>
            ${matches}
          </div>
        </div>`;
    };

    const centerLastIfRemainderOne = () => {
      const cols = matchMedia('(min-width:1280px)').matches ? 3 : (matchMedia('(min-width:768px)').matches ? 2 : 1);
      Array.from(projectsGrid.children).forEach(el => { el.style.gridColumn = ''; });
      if (cols !== 3) return;
      const items = projectsGrid.children;
      if (!items.length) return;
      if (items.length % 3 === 1) {
        items[items.length - 1].style.gridColumn = '2';
      }
    };

    const renderProjects = (filtered, animate=true, query='') => {
      const qNorm = normalize(query);
      if (animate) projectsGrid.classList.add('filtering');
      requestAnimationFrame(() => {
        projectsGrid.innerHTML = filtered.length
          ? filtered.map(p => cardHTML(p, qNorm)).join('')
          : '<p class="text-center text-gray-400 col-span-full">Aucune production ne correspond √† votre recherche.</p>';
        requestAnimationFrame(() => {
          projectsGrid.classList.remove('filtering');
          centerLastIfRemainderOne();
        });
      });
      live.textContent = `${filtered.length} projet${filtered.length>1?'s':''} affich√©${filtered.length>1?'s':''}`;
    };

    const filterData = (query) => {
      const q = normalize(query.trim());
      if (!q) return preIndexed;
      return preIndexed.filter(p => p.studentNamesNorm.some(n => n.includes(q)));
    };

    const updateAutocomplete = (value) => {
      const v = normalize(value.trim());
      autocompleteList.innerHTML = '';
      if (!v) { autocompleteList.classList.add('hidden'); studentSearch.setAttribute('aria-expanded','false'); activeSuggestion = -1; return; }
      const suggestions = allStudentNames.filter(n => normalize(n).includes(v)).slice(0,8);
      if (!suggestions.length) { autocompleteList.classList.add('hidden'); studentSearch.setAttribute('aria-expanded','false'); activeSuggestion = -1; return; }
      const frag = document.createDocumentFragment();
      suggestions.forEach((name, idx) => {
        const item = document.createElement('div');
        item.id = `suggestion-${idx}`;
        item.className = 'px-4 py-2 text-gray-300 hover:bg-black/20 cursor-pointer focus:bg-black/20 focus:outline-none';
        item.textContent = name; item.role = 'option'; item.tabIndex = -1; item.setAttribute('aria-selected','false');
        item.addEventListener('click', () => {
          studentSearch.value = name;
          autocompleteList.classList.add('hidden'); studentSearch.setAttribute('aria-expanded','false'); activeSuggestion = -1;
          applyFilter();
        });
        frag.appendChild(item);
      });
      autocompleteList.appendChild(frag);
      autocompleteList.classList.remove('hidden'); studentSearch.setAttribute('aria-expanded','true');
    };

    const openModal = (projectId) => {
      const project = projectData.find(p => p.id == projectId);
      if (!project) return;
      document.body.style.overflow = 'hidden';
      previouslyFocusedElement = document.activeElement;

      modalTitle.textContent = project.name;
      modalBody.innerHTML = '';

      const brief = document.createElement('div');
      brief.className = 'bg-black/20 p-6 rounded-lg mb-8';
      brief.innerHTML = `<h3 class=\"text-xl font-semibold text-gold mb-2\">Brief du Film</h3><p class=\"text-base text-gray-300\">${escapeHTML(project.mission)}</p>`;

      const missionsTitle = document.createElement('h4');
      missionsTitle.className = 'text-xl font-semibold text-gold mb-2';
      missionsTitle.textContent = 'Missions des R√©alisateurs';

      const studentsContainer = document.createElement('div');
      const searchValue = normalize(studentSearch.value || '');
      project.students.forEach(st => {
        const isHighlighted = searchValue && normalize(st.name).includes(searchValue);
        const wrap = document.createElement('div');
        wrap.className = `py-4 border-b border-card last:border-b-0 -mx-6 px-6 ${isHighlighted ? 'highlight' : ''}`;
        wrap.innerHTML = `
          <div class=\"flex items-center justify-between gap-4\">
            <p class=\"font-bold text-lg text-white\">${escapeHTML(st.name)}</p>
            <span class=\"text-sm font-medium flex-shrink-0 ${'${'}st.class === 'A' ? 'bg-red-900/50 text-red-200' : 'bg-blue-900/50 text-blue-200'${'}'} py-1 px-3 rounded-full\">Classe ${'${'}st.class${'}'}</span>
          </div>
          <div class=\"text-gray-400 mt-2\">
            <strong class=\"text-gold block font-medium\">${escapeHTML(st.mission.title)}</strong>
            <p class=\"text-sm mt-1 text-gray-300\">${escapeHTML(st.mission.description)}</p>
          </div>`;
        studentsContainer.appendChild(wrap);
      });

      modalBody.appendChild(brief);
      modalBody.appendChild(missionsTitle);
      modalBody.appendChild(studentsContainer);

      modal.classList.remove('invisible','opacity-0');
      $$('.modal-content', modal).classList.remove('-translate-y-10');

      const focusables = $$$('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])', modal);
      if (focusables.length) focusables[0].focus();
    };

    const closeModal = () => {
      document.body.style.overflow = '';
      modal.classList.add('invisible','opacity-0');
      $$('.modal-content', modal).classList.add('-translate-y-10');
      if (previouslyFocusedElement) previouslyFocusedElement.focus();
    };

    // Fermeture au clic en dehors de la modale + blocage de la propagation interne
    modal.addEventListener('click', (e) => {
      const content = $$('.modal-content', modal);
      if (!content.contains(e.target)) closeModal();
    });
    $$('.modal-content', modal).addEventListener('click', (e) => e.stopPropagation());

    const handleKeydown = (e) => {
      if (e.key === '/' && document.activeElement !== studentSearch && !e.ctrlKey && !e.metaKey && !e.altKey) { e.preventDefault(); studentSearch.focus(); return; }
      if (modal.classList.contains('invisible')) return;
      const focusables = Array.from($$$('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])', modal));
      if (!focusables.length) return;
      const first = focusables[0]; const last = focusables[focusables.length - 1];
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      } else if (e.key === 'Escape') { closeModal(); }
    };

    // Delegation cartes
    projectsGrid.addEventListener('click', (e) => {
      const card = e.target.closest('[data-project-id]');
      if (card) openModal(card.dataset.projectId);
    });
    projectsGrid.addEventListener('keydown', (e) => {
      const card = e.target.closest('[data-project-id]');
      if (!card) return;
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModal(card.dataset.projectId); }
    });

    $$('#modal-close').addEventListener('click', closeModal);
    document.addEventListener('keydown', handleKeydown, { passive: false });

    const applyFilter = () => {
      const query = studentSearch.value;
      if (query === lastQuery) { updateAutocomplete(query); return; }
      lastQuery = query;
      const filtered = filterData(query);
      renderProjects(filtered, true, query);
      updateAutocomplete(query);
    };

    const debouncedApply = debounce(applyFilter, 120);
    studentSearch.addEventListener('input', debouncedApply);
    studentSearch.addEventListener('keydown', (e) => {
      const opts = $$$('[role="option"]', autocompleteList);
      if (autocompleteList.classList.contains('hidden') || !opts.length) return;
      if (e.key === 'ArrowDown') { e.preventDefault(); activeSuggestion = (activeSuggestion + 1) % opts.length; }
      else if (e.key === 'ArrowUp') { e.preventDefault(); activeSuggestion = (activeSuggestion - 1 + opts.length) % opts.length; }
      else if (e.key === 'Enter') { if (activeSuggestion > -1) { e.preventDefault(); opts[activeSuggestion].click(); } return; }
      else if (e.key === 'Escape') { autocompleteList.classList.add('hidden'); studentSearch.setAttribute('aria-expanded','false'); activeSuggestion = -1; return; }
      else { activeSuggestion = -1; return; }
      opts.forEach((el,i)=>{ el.classList.toggle('suggestion-active', i===activeSuggestion); el.setAttribute('aria-selected', i===activeSuggestion ? 'true':'false'); });
      studentSearch.setAttribute('aria-activedescendant', opts[activeSuggestion].id);
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#student-search') && !e.target.closest('#autocomplete-list')) {
        autocompleteList.classList.add('hidden'); studentSearch.setAttribute('aria-expanded','false'); activeSuggestion = -1;
      }
    }, { passive: true });

    window.addEventListener('resize', debounce(centerLastIfRemainderOne, 150));

    // Initial render
    renderProjects(preIndexed, false, '');
  </script>
</body>
</html>
